<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharma PWA Expert</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="manifest" href="manifest.json">
    <style>
        body { padding-bottom: 100px; background-color: #f0f2f5; }
        .header-app { background: linear-gradient(135deg, #0d6efd, #0a58ca); color: white; padding: 15px; border-radius: 0 0 20px 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .scanner-box { width: 100%; display: none; background: #000; border-radius: 10px; margin-bottom: 10px; overflow: hidden; }
        .filter-section { background: white; padding: 15px; border-radius: 10px; margin-top: -20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .product-card { border: none; border-left: 5px solid transparent; margin-bottom: 10px; transition: transform 0.2s; }
        .product-card.done { border-left-color: #198754; background-color: #f8fffb; }
        .product-card.todo { border-left-color: #ffc107; }
        .offline-badge { position: fixed; top: 10px; right: 10px; z-index: 9999; }
        .nav-bottom { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #dee2e6; padding: 10px; display: flex; justify-content: space-around; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .big-input { font-size: 1.3rem; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<!-- Badge Statut -->
<div id="statusIndicator" class="badge bg-success offline-badge">En Ligne</div>

<!-- En-t√™te -->
<div class="header-app pb-5">
    <h4 class="m-0 fw-bold">üì¶ Gestion Stock</h4>
    <small id="totalCountInfo">Chargement...</small>
</div>

<div class="container">
    <!-- Section Filtres (Le c≈ìur du flux de travail) -->
    <div class="filter-section mx-2 mb-3">
        <div class="row g-2">
            <div class="col-6">
                <label class="small text-muted fw-bold">1. D√âP√îT</label>
                <select id="depotSelect" class="form-select form-select-sm">
                    <option value="Depot_Principal">Principal</option>
                    <option value="Depot_Secondaire">Secondaire</option>
                    <option value="Depot_Reserve">R√©serve</option>
                </select>
            </div>
            <div class="col-6">
                <label class="small text-muted fw-bold">2. FAMILLE</label>
                <select id="familySelect" class="form-select form-select-sm">
                    <option value="ALL">Toutes les familles</option>
                    <!-- Rempli dynamiquement -->
                </select>
            </div>
        </div>
    </div>

    <!-- Barre Recherche & Scan -->
    <div class="input-group mb-3 shadow-sm">
        <input type="text" id="searchInput" class="form-control" placeholder="üîç Rechercher (Nom, Code...)">
        <button class="btn btn-dark" onclick="startScanner()">üì∑ SCAN</button>
    </div>

    <div id="reader" class="scanner-box"></div>

    <!-- Liste Produits -->
    <div id="productList" class="pb-3">
        <!-- Les cartes produits s'affichent ici -->
    </div>
</div>

<!-- MODALE FICHE PRODUIT COMPLETE -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title text-primary fw-bold">üìù Fiche Produit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="inventoryForm">
                    <input type="hidden" id="itemId">
                    
                    <!-- Bloc Infos Fixes -->
                    <div class="p-2 bg-light rounded mb-3 border">
                        <div class="row g-2">
                            <div class="col-12">
                                <label class="small text-muted">D√©signation (DCI)</label>
                                <input type="text" id="modalDesignation" class="form-control fw-bold" placeholder="Nom du produit">
                            </div>
                            <div class="col-6">
                                <label class="small text-muted">Famille</label>
                                <input type="text" id="modalFamille" class="form-control form-control-sm">
                            </div>
                            <div class="col-6">
                                <label class="small text-muted">Unit√©</label>
                                <input type="text" id="modalUnite" class="form-control form-control-sm">
                            </div>
                        </div>
                    </div>

                    <!-- Bloc Lot & Date -->
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="fw-bold text-dark">Num√©ro Lot</label>
                            <input type="text" id="modalLot" class="form-control font-monospace bg-white border-warning">
                        </div>
                        <div class="col-6">
                            <label class="fw-bold text-dark">P√©remption</label>
                            <input type="date" id="modalDate" class="form-control border-warning">
                        </div>
                    </div>

                    <!-- Bloc Stock (Le c≈ìur de l'inventaire) -->
                    <div class="row g-2 align-items-end mb-3 p-3 border border-primary rounded bg-white">
                        <div class="col-5">
                            <label class="small text-muted">Stock Th√©orique</label>
                            <input type="number" id="modalQteTheo" class="form-control text-muted" placeholder="0">
                        </div>
                        <div class="col-7 text-center">
                            <label class="fw-bold text-primary mb-1">STOCK PHYSIQUE</label>
                            <input type="number" id="modalQtePhys" class="form-control big-input border-primary" placeholder="0">
                        </div>
                    </div>

                    <!-- Bloc Codes Barres -->
                    <div class="mb-2">
                        <label class="small text-muted">Codes Barres (Ajouter ou Scanner)</label>
                        <div class="input-group">
                            <input type="text" id="modalBarcodes" class="form-control form-control-sm">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="alert('Pour ajouter un code, scannez-le ou √©crivez-le √† la suite avec une virgule.')">‚ÑπÔ∏è</button>
                        </div>
                        <small class="text-muted" style="font-size: 0.7rem;">S√©parez les codes multiples par des virgules.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary fw-bold px-4" onclick="saveItem()">üíæ VALIDER</button>
            </div>
        </div>
    </div>
</div>

<!-- Navigation Bas -->
<div class="nav-bottom">
    <button class="btn btn-light text-secondary" onclick="addNewItem()">‚ûï Cr√©er Produit</button>
    <button class="btn btn-primary shadow fw-bold px-4" onclick="syncData()">üîÑ SYNCHRONISER</button>
    <div class="text-muted small align-self-center" id="lastSyncTime"></div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- CONFIGURATION ---
    // URL DE VOTRE SCRIPT GOOGLE :
    const API_URL = "https://script.google.com/macros/s/AKfycbzzv4nwHUPuCRwaAcMRrTfEcOB40xJ8hxHhO6cAjxq3N2FSuZzNBhlvtmzKoMZEnQPp/exec";

    // --- BDD Locale ---
    const db = new Dexie("PharmaStockDB_V3"); // V3 pour structure propre
    db.version(1).stores({
        products: "ID, Famille, Designation, Barcodes, NumeroLot, Depot"
    });

    let currentDepot = "Depot_Principal";
    let currentFamily = "ALL";
    let html5QrcodeScanner = null;

    // --- INITIALISATION ---
    document.addEventListener('DOMContentLoaded', () => {
        setupOfflineDetection();
        loadDataLocal();

        // Ecouteurs de filtres
        document.getElementById('depotSelect').addEventListener('change', (e) => {
            currentDepot = e.target.value;
            renderList();
        });
        document.getElementById('familySelect').addEventListener('change', (e) => {
            currentFamily = e.target.value;
            renderList();
        });
        document.getElementById('searchInput').addEventListener('input', (e) => {
            renderList(e.target.value);
        });
    });

    // --- LOGIQUE METIER ---

    // 1. Charger et Analyser les donn√©es pour les filtres
    async function loadDataLocal() {
        const count = await db.products.count();
        document.getElementById('totalCountInfo').innerText = `${count} r√©f√©rences en m√©moire`;
        
        if (count > 0) {
            await updateFamilyDropdown();
            renderList();
        } else {
            document.getElementById('productList').innerHTML = 
                `<div class="text-center mt-5 p-4"><p class="text-muted">Aucune donn√©e.</p>
                <button class="btn btn-primary" onclick="syncData()">üì• T√©l√©charger la base Google Sheet</button></div>`;
        }
    }

    // 2. Mettre √† jour la liste des Familles (dynamique)
    async function updateFamilyDropdown() {
        const allItems = await db.products.where('Depot').equals(currentDepot).toArray();
        // Extraction des familles uniques
        const families = [...new Set(allItems.map(item => item.Famille || "NON CLASSE"))].sort();
        
        const select = document.getElementById('familySelect');
        // Sauvegarde de la s√©lection actuelle si possible
        const oldVal = select.value;
        
        select.innerHTML = '<option value="ALL">Toutes les familles</option>';
        families.forEach(fam => {
            if(fam.trim() !== "") {
                select.innerHTML += `<option value="${fam}">${fam}</option>`;
            }
        });
        select.value = "ALL"; // Reset par d√©faut ou remettre oldVal si vous pr√©f√©rez
    }

    // 3. Afficher la liste (Inventaire)
    async function renderList(filterText = "") {
        const listEl = document.getElementById('productList');
        listEl.innerHTML = "";

        // Etape A: Filtre D√©p√¥t
        let items = await db.products.where('Depot').equals(currentDepot).toArray();

        // Etape B: Filtre Famille
        if (currentFamily !== "ALL") {
            items = items.filter(i => i.Famille === currentFamily);
        }

        // Etape C: Recherche Texte / Code Barre
        if (filterText) {
            const lowerFilter = filterText.toLowerCase();
            items = items.filter(item => 
                (item.Designation && item.Designation.toLowerCase().includes(lowerFilter)) ||
                (item.Barcodes && item.Barcodes.includes(filterText)) || 
                (item.NumeroLot && item.NumeroLot.toLowerCase().includes(lowerFilter))
            );
        }

        // Affichage
        if (items.length === 0) {
            listEl.innerHTML = `<div class="text-center text-muted mt-4">Aucun produit ne correspond aux filtres.</div>`;
            return;
        }

        items.forEach(item => {
            // Statut: Vert si compt√©, Orange si √† faire
            const isDone = (item.QtePhysique !== "" && item.QtePhysique !== null && item.QtePhysique !== undefined);
            const cardClass = isDone ? "done" : "todo";
            const valPhys = isDone ? item.QtePhysique : '...';

            const html = `
                <div class="card product-card ${cardClass} shadow-sm" onclick="openEditModal('${item.ID}')">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h6 class="card-title m-0 fw-bold text-truncate" style="max-width: 80%;">${item.Designation}</h6>
                            <span class="badge bg-light text-dark border">${item.Unite || 'U'}</span>
                        </div>
                        <div class="d-flex justify-content-between small text-muted mb-2">
                            <span>Lot: <b class="text-dark">${item.NumeroLot || '-'}</b></span>
                            <span>Exp: ${formatDate(item.DatePeremption)}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                            <span class="text-muted small">Th√©o: <b>${item.QteTheorique}</b></span>
                            <div class="${isDone ? 'text-success' : 'text-secondary'} fw-bold" style="font-size:1.1rem">
                                Phys: ${valPhys}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            listEl.innerHTML += html;
        });
    }

    // --- MODALE & EDITION ---
    async function openEditModal(id) {
        const item = await db.products.get(id);
        if(!item) return;

        document.getElementById('itemId').value = item.ID;
        document.getElementById('modalDesignation').value = item.Designation;
        document.getElementById('modalFamille').value = item.Famille;
        document.getElementById('modalUnite').value = item.Unite;
        document.getElementById('modalLot').value = item.NumeroLot;
        let dateVal = item.DatePeremption ? new Date(item.DatePeremption).toISOString().split('T')[0] : "";
        document.getElementById('modalDate').value = dateVal;
        
        document.getElementById('modalQteTheo').value = item.QteTheorique;
        document.getElementById('modalQtePhys').value = item.QtePhysique;
        document.getElementById('modalBarcodes').value = item.Barcodes;

        // Si on a un scanner actif qui a d√©clench√© l'ouverture, on peut ajouter le code automatiquement si besoin
        // (Logique simplifi√©e ici)

        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
        
        // Focus auto sur la quantit√© physique
        setTimeout(() => document.getElementById('modalQtePhys').focus(), 500);
    }

    async function addNewItem() {
        // Mode cr√©ation: On demande √† l'utilisateur de remplir la base
        const newId = "NEW_" + Date.now(); 
        const newItem = {
            ID: newId,
            Designation: "", // Vide pour forcer la saisie
            Famille: currentFamily !== "ALL" ? currentFamily : "DIVERS",
            Depot: currentDepot,
            QteTheorique: 0,
            QtePhysique: "",
            Barcodes: "",
            NumeroLot: "",
            Unite: "Bt"
        };
        await db.products.put(newItem);
        openEditModal(newId);
        
        // Petit message pour guider
        setTimeout(() => document.getElementById('modalDesignation').focus(), 600);
    }

    async function saveItem() {
        const id = document.getElementById('itemId').value;
        const item = await db.products.get(id);

        if(item) {
            // On met √† jour TOUTES les infos (Gestion + Inventaire)
            item.Designation = document.getElementById('modalDesignation').value;
            item.Famille = document.getElementById('modalFamille').value;
            item.Unite = document.getElementById('modalUnite').value;
            item.NumeroLot = document.getElementById('modalLot').value;
            item.DatePeremption = document.getElementById('modalDate').value;
            item.QteTheorique = document.getElementById('modalQteTheo').value; // Actualisation Th√©o possible
            item.QtePhysique = document.getElementById('modalQtePhys').value;
            item.Barcodes = document.getElementById('modalBarcodes').value;
            
            await db.products.put(item);
            
            // Fermeture et rafraichissement
            const modalEl = document.getElementById('productModal');
            bootstrap.Modal.getInstance(modalEl).hide();
            
            // Si la famille a chang√©, on met √† jour le dropdown
            updateFamilyDropdown();
            renderList();
        }
    }

    // --- SCANNER GS1 INTELLIGENT ---
    function parseGS1(code) {
        // M√™me logique que pr√©c√©demment (DataMatrix)
        let res = { gtin: null, lot: null, exp: null };
        let clean = code.replace(/[\(\)]/g, '');
        let mGtin = clean.match(/(?:01)(\d{14})/); if(mGtin) res.gtin = mGtin[1];
        let mDate = clean.match(/17(\d{6})/); if(mDate) res.exp = parseGS1Date(mDate[1]);
        let mLot = clean.match(/10([A-Za-z0-9\-\.]+)/); 
        if(mLot) {
            let l = mLot[1];
            let idx = l.indexOf('17');
            if(idx > -1 && l.length - idx >= 8) l = l.substring(0, idx);
            res.lot = l;
        }
        return res;
    }
    function parseGS1Date(d) {
        if(!d || d.length !== 6) return "";
        let y = parseInt(d.substring(0,2)); y += (y>50?1900:2000);
        let da = (d.substring(4,6)==="00")?"28":d.substring(4,6);
        return `${y}-${d.substring(2,4)}-${da}`;
    }

    function startScanner() {
        document.getElementById('reader').style.display = "block";
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start({ facingMode: "environment" }, {fps:10, qrbox:250},
            async (code) => {
                await html5QrcodeScanner.stop();
                document.getElementById('reader').style.display = "none";
                handleScan(code);
            },
            () => {}
        );
    }

    async function handleScan(code) {
        const gs1 = parseGS1(code);
        let search = gs1.gtin ? (gs1.gtin.startsWith('0')?gs1.gtin.substring(1):gs1.gtin) : code;
        
        // On remplit la barre de recherche
        document.getElementById('searchInput').value = search;
        
        // Recherche globale dans le d√©p√¥t (m√™me si famille masqu√©e)
        const allItems = await db.products.where('Depot').equals(currentDepot).toArray();
        let found = allItems.find(i => i.Barcodes && i.Barcodes.includes(search));
        
        if(found) {
            // Si trouv√© mais dans une autre famille, on bascule la vue
            if (currentFamily !== "ALL" && found.Famille !== currentFamily) {
                if(confirm(`Produit trouv√© dans la famille "${found.Famille}". Basculer la vue ?`)) {
                    document.getElementById('familySelect').value = found.Famille;
                    currentFamily = found.Famille;
                    renderList();
                }
            }
            // Ouverture fiche
            await openEditModal(found.ID);
            // Auto-fill Lot/Date
            if(gs1.lot) document.getElementById('modalLot').value = gs1.lot;
            if(gs1.exp) document.getElementById('modalDate').value = gs1.exp;
            
        } else {
            if(confirm(`Nouveau produit ou code inconnu : ${search}\nL'ajouter maintenant ?`)) {
                await addNewItem();
                setTimeout(() => {
                    document.getElementById('modalBarcodes').value = search;
                    if(gs1.lot) document.getElementById('modalLot').value = gs1.lot;
                    if(gs1.exp) document.getElementById('modalDate').value = gs1.exp;
                }, 500);
            }
        }
    }

    // --- SYNCHRONISATION ---
    async function syncData() {
        const btn = document.querySelector('.nav-bottom .btn-primary');
        const oldTxt = btn.innerHTML;
        btn.innerHTML = "‚è≥ Envoi...";
        btn.disabled = true;

        try {
            // 1. Envoi
            const all = await db.products.toArray();
            await fetch(API_URL, {
                method: 'POST', mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(all)
            });

            // 2. Attente & R√©ception
            btn.innerHTML = "üì• R√©ception...";
            await new Promise(r => setTimeout(r, 2000));
            
            const res = await fetch(API_URL);
            const data = await res.json();
            
            await db.products.clear();
            await db.products.bulkPut(data);
            
            alert(`‚úÖ Synchronisation r√©ussie !\n${data.length} produits mis √† jour.`);
            loadDataLocal(); // Recharge les familles et la liste

        } catch(e) {
            alert("Erreur Sync : " + e);
        } finally {
            btn.innerHTML = oldTxt;
            btn.disabled = false;
        }
    }

    function setupOfflineDetection() { /* M√™me code que pr√©c√©dement */ }
    function formatDate(d) { if(!d) return ""; return new Date(d).toLocaleDateString('fr-FR'); }
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');
</script>
</body>
</html>