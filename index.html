<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pharma Master Base</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link rel="manifest" href="manifest.json">
    
    <style>
        body { padding-bottom: 90px; background-color: #f0f2f5; font-family: system-ui, -apple-system, sans-serif; }
        .header-app { background: linear-gradient(135deg, #0d6efd, #0043a8); color: white; padding: 15px 15px 30px 15px; border-radius: 0 0 25px 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .filter-section { background: white; padding: 15px; border-radius: 15px; margin-top: -25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .product-card { border: none; border-radius: 12px; margin-bottom: 12px; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.02); border-left: 5px solid #e9ecef; }
        .product-card.done { border-left-color: #198754; background-color: #f8fffb; }
        .product-card.todo { border-left-color: #ffc107; }
        .scanner-box { width: 100%; display: none; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 15px; border: 3px solid #333; }
        .nav-bottom { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); border-top: 1px solid #e0e0e0; padding: 10px; display: flex; justify-content: space-around; z-index: 1000; }
        .barcode-tag { background-color: #e9ecef; border: 1px solid #ced4da; border-radius: 20px; padding: 3px 10px; font-family: monospace; display: inline-flex; align-items: center; margin-right: 5px; margin-bottom: 5px; font-size: 0.85rem; }
        .offline-badge { position: fixed; top: 15px; right: 15px; z-index: 9999; }
        .price-tag { font-weight: bold; color: #198754; background: #d1e7dd; padding: 2px 8px; border-radius: 4px; font-size: 0.9em; }
    </style>
</head>
<body>

<div id="statusIndicator" class="badge bg-success offline-badge">En Ligne</div>

<div class="header-app">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h4 class="m-0 fw-bold"><i class="bi bi-database-check"></i> Stock Master</h4>
            <small class="opacity-75" id="totalCountInfo">Chargement...</small>
        </div>
        <button class="btn btn-sm btn-outline-light rounded-pill" onclick="openConfigModal()"><i class="bi bi-gear-fill"></i></button>
    </div>
</div>

<div class="container mb-5">
    <!-- Filtres -->
    <div class="filter-section mx-1">
        <div class="row g-2">
            <div class="col-6">
                <label class="small text-muted fw-bold">DÃ‰PÃ”T ACTIF</label>
                <select id="depotSelect" class="form-select form-select-sm fw-bold border-primary text-primary">
                    <!-- JS -->
                </select>
            </div>
            <div class="col-6">
                <label class="small text-muted fw-bold">FAMILLE</label>
                <select id="familySelect" class="form-select form-select-sm">
                    <option value="ALL">ðŸ“‚ Tout voir</option>
                    <!-- JS -->
                </select>
            </div>
        </div>
    </div>

    <!-- Scanner -->
    <div id="reader" class="scanner-box"></div>
    
    <div class="input-group mb-3 shadow-sm">
        <input type="text" id="searchInput" class="form-control" placeholder="Recherche globale...">
        <button class="btn btn-dark" onclick="startScanner('search')"><i class="bi bi-qr-code-scan"></i> SCAN</button>
    </div>

    <!-- Liste -->
    <div id="productList" class="pb-2"></div>
</div>

<!-- MODALE FICHE PRODUIT -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light py-2">
                <h6 class="modal-title fw-bold text-primary"><i class="bi bi-pencil-square"></i> Fiche Article</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <form id="inventoryForm">
                    <input type="hidden" id="itemId">
                    
                    <!-- Identification -->
                    <div class="mb-3">
                        <label class="small text-muted">DÃ©signation (DCI)</label>
                        <input type="text" id="modalDesignation" class="form-control fw-bold">
                    </div>

                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="small text-muted">Famille</label>
                            <select id="modalFamille" class="form-select form-select-sm"></select>
                        </div>
                        <div class="col-6">
                            <label class="small text-muted">Prix de Vente</label>
                            <div class="input-group input-group-sm">
                                <input type="number" id="modalPrix" class="form-control fw-bold text-success">
                                <span class="input-group-text">FCFA</span>
                            </div>
                        </div>
                    </div>

                    <!-- Lot & Date -->
                    <div class="card bg-light border-0 p-2 mb-3">
                        <div class="row g-2">
                            <div class="col-4">
                                <label class="small fw-bold">UnitÃ©</label>
                                <input type="text" id="modalUnite" class="form-control form-control-sm bg-white">
                            </div>
                            <div class="col-4">
                                <label class="small fw-bold">Lot</label>
                                <input type="text" id="modalLot" class="form-control form-control-sm font-monospace border-warning bg-white">
                            </div>
                            <div class="col-4">
                                <label class="small fw-bold">Exp</label>
                                <input type="date" id="modalDate" class="form-control form-control-sm border-warning bg-white">
                            </div>
                        </div>
                    </div>

                    <!-- QuantitÃ©s -->
                    <div class="row g-2 align-items-center mb-3">
                        <div class="col-4">
                            <label class="small text-muted text-center w-100">ThÃ©orique</label>
                            <input type="number" id="modalQteTheo" class="form-control text-center bg-white border-0" readonly>
                        </div>
                        <div class="col-8">
                            <label class="small fw-bold text-primary text-center w-100">STOCK PHYSIQUE</label>
                            <input type="number" id="modalQtePhys" class="form-control form-control-lg text-center border-primary fw-bold" style="font-size:1.5rem">
                        </div>
                    </div>

                    <!-- Codes Barres -->
                    <div class="border-top pt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="small text-muted fw-bold">Codes Barres (Multiples)</label>
                            <button type="button" class="btn btn-sm btn-outline-dark" onclick="startScanner('add_barcode')">
                                <i class="bi bi-plus-lg"></i> Scan
                            </button>
                        </div>
                        <div id="barcodeTagsContainer" class="p-2 bg-light rounded mb-2" style="min-height: 40px;"></div>
                        <div class="input-group input-group-sm">
                            <input type="text" id="manualBarcodeInput" class="form-control" placeholder="Ajout manuel...">
                            <button class="btn btn-outline-secondary" type="button" onclick="addManualBarcode()">Ajouter</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-primary w-100 fw-bold" onclick="saveItem()">ðŸ’¾ ENREGISTRER</button>
            </div>
        </div>
    </div>
</div>

<!-- MODALE CONFIG -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title fw-bold">ParamÃ¨tres</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="configTabs">
                    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabDepots">DÃ©pÃ´ts</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabFamilies">Familles</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="tabDepots">
                        <div class="input-group mb-2">
                            <input type="text" id="newDepotName" class="form-control" placeholder="Nouveau dÃ©pÃ´t...">
                            <button class="btn btn-success" onclick="addConfigItem('depots')">CrÃ©er</button>
                        </div>
                        <ul class="list-group" id="configDepotList"></ul>
                    </div>
                    <div class="tab-pane fade" id="tabFamilies">
                        <div class="input-group mb-2">
                            <input type="text" id="newFamilyName" class="form-control" placeholder="Nouvelle famille...">
                            <button class="btn btn-success" onclick="addConfigItem('families')">CrÃ©er</button>
                        </div>
                        <ul class="list-group" id="configFamilyList"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NAV -->
<div class="nav-bottom">
    <button class="nav-btn" onclick="addNewItem()">
        <i class="bi bi-plus-circle-fill fs-3 text-primary"></i><span>Nouveau</span>
    </button>
    <button class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" onclick="syncData()">
        <i class="bi bi-arrow-repeat"></i> SYNCHRO
    </button>
    <button class="nav-btn" onclick="location.reload()">
        <i class="bi bi-house-door"></i><span>Accueil</span>
    </button>
</div>

<!-- LOGIC -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- CONFIG ---
    const API_URL = "https://script.google.com/macros/s/AKfycbzzv4nwHUPuCRwaAcMRrTfEcOB40xJ8hxHhO6cAjxq3N2FSuZzNBhlvtmzKoMZEnQPp/exec";
    
    const db = new Dexie("PharmaMasterDB");
    db.version(1).stores({ products: "ID, Famille, Designation, Barcodes, NumeroLot, Depot, PrixVente" });

    let currentDepot = "";
    let currentFamily = "ALL";
    let html5QrcodeScanner = null;
    let scanMode = "search"; 
    let currentEditingBarcodes = [];

    let userDepots = JSON.parse(localStorage.getItem('userDepots')) || ['Depot_Principal', 'BASE_ARTICLES'];
    let userFamilies = JSON.parse(localStorage.getItem('userFamilies')) || ['NON CLASSE'];

    document.addEventListener('DOMContentLoaded', () => {
        setupOfflineDetection();
        loadDataLocal(); 
        currentDepot = userDepots[0];
        updateDropdownsUI();
        
        document.getElementById('depotSelect').addEventListener('change', (e) => { currentDepot = e.target.value; renderList(); });
        document.getElementById('familySelect').addEventListener('change', (e) => { currentFamily = e.target.value; renderList(); });
        document.getElementById('searchInput').addEventListener('input', (e) => handleSmartSearch(e.target.value));
    });

    // --- LOGIQUE MASTER BASE (RECHERCHE GLOBALE) ---
    async function handleSmartSearch(text) {
        if(!text) { renderList(); return; }
        
        const listEl = document.getElementById('productList');
        listEl.innerHTML = "";
        const lowerFilter = text.toLowerCase();

        // 1. Recherche dans le DEPOT ACTUEL
        const localItems = await db.products.where('Depot').equals(currentDepot).toArray();
        let matches = localItems.filter(item => 
            (item.Designation && item.Designation.toLowerCase().includes(lowerFilter)) ||
            (item.Barcodes && item.Barcodes.includes(text)) || 
            (item.NumeroLot && item.NumeroLot.toLowerCase().includes(lowerFilter))
        );

        // 2. Si pas trouvÃ©, Recherche GLOBALE (dans toute la BDD)
        let globalMatches = [];
        if(matches.length === 0) {
            const allItems = await db.products.toArray();
            globalMatches = allItems.filter(item => 
                // On exclut ceux du dÃ©pÃ´t actuel car dÃ©jÃ  checkÃ©s
                item.Depot !== currentDepot && (
                    (item.Designation && item.Designation.toLowerCase().includes(lowerFilter)) ||
                    (item.Barcodes && item.Barcodes.includes(text))
                )
            );
            // On dÃ©doublonne par ID (on veut juste la fiche produit, pas 15 lots diffÃ©rents)
            globalMatches = globalMatches.filter((v,i,a)=>a.findIndex(t=>(t.ID === v.ID))===i);
        }

        // AFFICHAGE
        if (matches.length > 0) {
            // Affichage normal
            renderItemsHTML(matches, listEl);
        } else if (globalMatches.length > 0) {
            // Affichage "PRODUITS TROUVÃ‰S AILLEURS"
            listEl.innerHTML = `<div class="alert alert-info small py-1"><i class="bi bi-info-circle"></i> Produit non trouvÃ© ici, mais existe dans la base.</div>`;
            globalMatches.forEach(masterItem => {
                const html = `
                    <div class="card product-card shadow-sm border-info" onclick="importFromMaster('${masterItem.ID}')">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between mb-1">
                                <h6 class="m-0 fw-bold text-primary"><i class="bi bi-cloud-download"></i> ${masterItem.Designation}</h6>
                                <span class="badge bg-info text-dark">IMPORT</span>
                            </div>
                            <small class="text-muted">Famille: ${masterItem.Famille} | Prix: ${masterItem.PrixVente || '?'} FCFA</small>
                            <div class="mt-2 text-end"><button class="btn btn-sm btn-outline-primary">Ajouter Ã  ${currentDepot}</button></div>
                        </div>
                    </div>`;
                listEl.innerHTML += html;
            });
        } else {
            listEl.innerHTML = `<div class="text-center text-muted mt-5">Aucun produit trouvÃ©.<br><button class="btn btn-sm btn-outline-secondary mt-2" onclick="addNewItem()">CrÃ©er Nouveau</button></div>`;
        }
    }

    // Fonction pour importer les donnÃ©es d'un autre dÃ©pÃ´t (Master) vers le dÃ©pÃ´t actuel
    async function importFromMaster(masterId) {
        const masterItem = await db.products.get(masterId);
        if(!masterItem) return;

        if(confirm(`Importer la fiche "${masterItem.Designation}" dans ${currentDepot} ?`)) {
            // On crÃ©e un nouvel ID unique pour ce stock spÃ©cifique
            const newStockId = masterItem.ID; // On garde le mÃªme ID produit (GEN_...)
            // Mais dexie stocke par "ID" qui est la clÃ© primaire.
            // ATTENTION : Dexie Ã©crase si ID identique. 
            // Astuce : Dans cette architecture simplifiÃ©e, on va ouvrir la modale de crÃ©ation
            // prÃ©-remplie, et l'utilisateur crÃ©era un nouveau lot pour ce dÃ©pÃ´t.
            
            // PrÃ©-remplissage des variables globales de modale
            await openEditModal(null, masterItem); // null = mode crÃ©ation, masterItem = donnÃ©es
        }
    }

    // --- STANDARD RENDERING ---
    async function renderList() {
        const listEl = document.getElementById('productList');
        listEl.innerHTML = "";
        let items = await db.products.where('Depot').equals(currentDepot).toArray();
        if (currentFamily !== "ALL") items = items.filter(i => i.Famille === currentFamily);
        renderItemsHTML(items, listEl);
    }

    function renderItemsHTML(items, container) {
        if (items.length === 0) {
            container.innerHTML = `<div class="text-center text-muted mt-5">Vide.</div>`;
            return;
        }
        items.forEach(item => {
            const isDone = (item.QtePhysique !== "" && item.QtePhysique !== undefined);
            const html = `
                <div class="card product-card ${isDone ? 'done' : 'todo'}" onclick="openEditModal('${item.ID}')">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between mb-1">
                            <h6 class="m-0 fw-bold text-truncate" style="max-width:70%">${item.Designation}</h6>
                            <span class="price-tag">${item.PrixVente ? item.PrixVente + ' F' : '-'}</span>
                        </div>
                        <div class="small text-muted d-flex justify-content-between">
                            <span>Lot: <b>${item.NumeroLot || '-'}</b></span>
                            <span>Exp: ${formatDate(item.DatePeremption)}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top">
                            <span class="text-muted small">ThÃ©o: ${item.QteTheorique}</span>
                            <span class="fs-5 fw-bold ${isDone ? 'text-success' : 'text-secondary'}">
                                Phys: ${isDone ? item.QtePhysique : '...'}
                            </span>
                        </div>
                    </div>
                </div>`;
            container.innerHTML += html;
        });
    }

    // --- MODALES & DATA ---
    async function openEditModal(id, importData = null) {
        let item = {};
        
        if (id) {
            // Mode Edition existant
            item = await db.products.get(id);
        } else if (importData) {
            // Mode Import depuis Master
            item = {
                ID: importData.ID, // On garde l'ID produit pour lier les fiches
                Designation: importData.Designation,
                Famille: importData.Famille,
                Unite: importData.Unite,
                PrixVente: importData.PrixVente,
                Barcodes: importData.Barcodes,
                Depot: currentDepot, // On force le dÃ©pÃ´t actuel
                NumeroLot: "", // On reset le lot car c'est un nouveau stock
                QteTheorique: 0,
                QtePhysique: ""
            };
        } else {
            // Mode Vierge
            item = { ID: "GEN_" + Date.now(), Depot: currentDepot, Famille: currentFamily!=="ALL"?currentFamily:"NON CLASSE", PrixVente:0 };
        }

        document.getElementById('itemId').value = item.ID; // Attention : Si import, c'est l'ID du produit
        // Pour diffÃ©rencier les lignes en BDD qui a ID comme clÃ© primaire unique, 
        // cette app simplifiÃ©e utilise l'ID pour identifier la ligne.
        // Si on importe, on risque d'Ã©craser si on ne change pas l'ID.
        // CORRECTION IMPORTANTE :
        if(importData) {
             // Si on importe, on crÃ©e techniquement une nouvelle entrÃ©e de stock
             // Mais on veut garder le lien... Dans ce systÃ¨me simple CSV, l'ID est unique par ligne.
             // On gÃ©nÃ¨re un nouvel ID de ligne pour le stockage
             document.getElementById('itemId').value = "STOCK_" + Date.now();
        }

        document.getElementById('modalDesignation').value = item.Designation || "";
        document.getElementById('modalFamille').value = item.Famille || "NON CLASSE";
        document.getElementById('modalUnite').value = item.Unite || "";
        document.getElementById('modalPrix').value = item.PrixVente || "";
        document.getElementById('modalLot').value = item.NumeroLot || "";
        let d = item.DatePeremption ? new Date(item.DatePeremption).toISOString().split('T')[0] : "";
        document.getElementById('modalDate').value = d;
        document.getElementById('modalQteTheo').value = item.QteTheorique || 0;
        document.getElementById('modalQtePhys').value = item.QtePhysique !== undefined ? item.QtePhysique : "";

        currentEditingBarcodes = item.Barcodes ? String(item.Barcodes).split(',').filter(c=>c.trim()!=="") : [];
        renderBarcodeTags();

        new bootstrap.Modal(document.getElementById('productModal')).show();
    }

    function renderBarcodeTags() {
        const c = document.getElementById('barcodeTagsContainer'); c.innerHTML = "";
        currentEditingBarcodes.forEach((code, i) => {
            c.innerHTML += `<span class="barcode-tag">${code} <button type="button" class="btn-close" onclick="removeBarcode(${i})"></button></span>`;
        });
    }
    function removeBarcode(i) { currentEditingBarcodes.splice(i, 1); renderBarcodeTags(); }
    function addManualBarcode() {
        const v = document.getElementById('manualBarcodeInput').value.trim();
        if(v && !currentEditingBarcodes.includes(v)) { currentEditingBarcodes.push(v); renderBarcodeTags(); document.getElementById('manualBarcodeInput').value=""; }
    }

    async function addNewItem() { await openEditModal(null); }

    async function saveItem() {
        const id = document.getElementById('itemId').value;
        // On construit l'objet
        const item = {
            ID: id,
            Designation: document.getElementById('modalDesignation').value,
            Famille: document.getElementById('modalFamille').value,
            Unite: document.getElementById('modalUnite').value,
            PrixVente: document.getElementById('modalPrix').value,
            NumeroLot: document.getElementById('modalLot').value,
            DatePeremption: document.getElementById('modalDate').value,
            QteTheorique: document.getElementById('modalQteTheo').value,
            QtePhysique: document.getElementById('modalQtePhys').value,
            Barcodes: currentEditingBarcodes.join(','),
            Depot: currentDepot
        };

        // SAUVEGARDE EN LOCAL
        await db.products.put(item);
        
        // LOGIQUE "MISE A JOUR BASE"
        // L'utilisateur veut que toute modif mette Ã  jour la "base".
        // Ici, la base EST l'ensemble des produits.
        // Donc si on change le prix ici, lors de la prochaine recherche globale, le nouveau prix apparaÃ®tra.
        // C'est automatique grÃ¢ce Ã  Dexie.

        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
        renderList();
    }

    // --- SCANNER ---
    function startScanner(mode) {
        scanMode = mode;
        document.getElementById('reader').style.display = "block";
        if(mode==='add_barcode') bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
        
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (code) => {
            await html5QrcodeScanner.stop();
            document.getElementById('reader').style.display = "none";
            handleScanResult(code);
        });
    }

    async function handleScanResult(code) {
        let clean = code.replace(/[\(\)]/g, ''); 
        // GS1 Extract simple
        if(clean.startsWith('01') && clean.length>14) clean = clean.substring(2,16).replace(/^0+/, ''); 

        if(scanMode === 'add_barcode') {
            const m = new bootstrap.Modal(document.getElementById('productModal')); m.show();
            if(!currentEditingBarcodes.includes(clean)) { currentEditingBarcodes.push(clean); renderBarcodeTags(); }
        } else {
            // RECHERCHE INTELLIGENTE
            document.getElementById('searchInput').value = clean;
            handleSmartSearch(clean);
        }
    }

    // --- SYNCHRO ---
    async function syncData() {
        const btn = document.querySelector('.btn-primary.rounded-pill');
        const oldTxt = btn.innerHTML;
        btn.innerHTML = "â³..."; btn.disabled = true;
        try {
            const allData = await db.products.toArray();
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type':'application/json'}, body: JSON.stringify(allData)});
            await new Promise(r => setTimeout(r, 2000));
            const res = await fetch(API_URL + "?t=" + Date.now());
            const raw = await res.json();
            
            const clean = raw.map(i => {
                const k = (n) => Object.keys(i).find(key => key.toLowerCase() === n.toLowerCase());
                return {
                    ID: i[k("id")] || ("GEN_" + Math.random()),
                    Famille: i[k("famille")] || "DIVERS",
                    Designation: i[k("designation")] || "?",
                    Unite: i[k("unite")] || "U",
                    Barcodes: String(i[k("barcodes")] || ""),
                    NumeroLot: String(i[k("numerolot")] || ""),
                    DatePeremption: i[k("dateperemption")] || "",
                    QteTheorique: i[k("qtetheorique")] || 0,
                    QtePhysique: i[k("qtephysique")],
                    Depot: i[k("depot")] || "Depot_Principal",
                    PrixVente: i[k("prixvente")] || "" // Import du prix
                };
            });
            await db.products.clear(); await db.products.bulkPut(clean);
            alert(`âœ… Synchro OK: ${clean.length} produits.`);
            location.reload();
        } catch(e) { alert("Erreur: " + e.message); } finally { btn.innerHTML = oldTxt; btn.disabled = false; }
    }

    // UTILS
    function updateDropdownsUI() {
        const d = document.getElementById('depotSelect'); d.innerHTML="";
        const cD = document.getElementById('configDepotList'); cD.innerHTML="";
        userDepots.forEach(x => {
            d.innerHTML+=`<option value="${x}">${x}</option>`;
            cD.innerHTML+=`<li class="list-group-item d-flex justify-content-between">${x} <button class="btn-close" onclick="removeConfig('depots','${x}')"></button></li>`;
        });
        d.value = currentDepot;
        
        const f = document.getElementById('familySelect'); f.innerHTML='<option value="ALL">ðŸ“‚ Tout voir</option>';
        const mF = document.getElementById('modalFamille'); mF.innerHTML='';
        const cF = document.getElementById('configFamilyList'); cF.innerHTML="";
        userFamilies.sort().forEach(x => {
            f.innerHTML+=`<option value="${x}">${x}</option>`;
            mF.innerHTML+=`<option value="${x}">${x}</option>`;
            cF.innerHTML+=`<li class="list-group-item d-flex justify-content-between">${x} <button class="btn-close" onclick="removeConfig('families','${x}')"></button></li>`;
        });
    }
    function addConfigItem(type) {
        const id = type==='depots'?'newDepotName':'newFamilyName';
        const v = document.getElementById(id).value.trim().replace(/ /g,'_');
        if(!v)return;
        if(type==='depots'){ if(!userDepots.includes(v)) userDepots.push(v); localStorage.setItem('userDepots',JSON.stringify(userDepots)); }
        else { if(!userFamilies.includes(v)) userFamilies.push(v.toUpperCase()); localStorage.setItem('userFamilies',JSON.stringify(userFamilies)); }
        document.getElementById(id).value=""; updateDropdownsUI();
    }
    function removeConfig(t,v){ 
        if(!confirm("Supprimer?"))return; 
        if(t==='depots'){ userDepots=userDepots.filter(x=>x!==v); if(userDepots.length===0)userDepots.push('Main'); localStorage.setItem('userDepots',JSON.stringify(userDepots));}
        else{ userFamilies=userFamilies.filter(x=>x!==v); localStorage.setItem('userFamilies',JSON.stringify(userFamilies));}
        updateDropdownsUI();
    }
    function setupOfflineDetection() { /*...*/ }
    function formatDate(d) { if(!d)return ""; const dd=new Date(d); return isNaN(dd)?d:dd.toLocaleDateString('fr-FR'); }
    if('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');
</script>
</body>
</html>