<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pharma Stock Ultimate</title>
    
    <!-- Bootstrap CSS & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <!-- Dexie (Base de donn√©es) & Scanner -->
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link rel="manifest" href="manifest.json">
    
    <style>
        /* Styles G√©n√©raux */
        body { padding-bottom: 100px; background-color: #f2f4f8; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        /* En-t√™te */
        .header-app { 
            background: linear-gradient(135deg, #0d6efd, #0043a8); 
            color: white; 
            padding: 15px 15px 35px 15px; 
            border-radius: 0 0 25px 25px; 
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3); 
        }
        
        /* Bouton Config (Roue) */
        .btn-config {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .btn-config:active { background: rgba(255,255,255,0.5); transform: scale(0.95); }

        /* Filtres */
        .filter-section { background: white; padding: 15px; border-radius: 15px; margin-top: -25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* Cartes Produits */
        .product-card { border: none; border-radius: 12px; margin-bottom: 12px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-left: 5px solid #e9ecef; }
        .product-card.done { border-left-color: #198754; background-color: #f8fffb; } /* Vert */
        .product-card.todo { border-left-color: #ffc107; } /* Jaune */
        .product-card.import { border-left-color: #0dcaf0; } /* Bleu Cyan */

        /* Tags et Badges */
        .barcode-tag { background-color: #e9ecef; border: 1px solid #dee2e6; border-radius: 15px; padding: 4px 10px; font-family: monospace; font-size: 0.85rem; display: inline-flex; align-items: center; margin-right: 5px; margin-bottom: 5px; }
        .price-badge { background-color: #d1e7dd; color: #0f5132; font-weight: bold; padding: 3px 8px; border-radius: 6px; font-size: 0.9em; }

        /* Scanner */
        .scanner-box { width: 100%; display: none; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 15px; border: 3px solid #333; position: relative; }
        .scanner-overlay { position: absolute; top: 10px; right: 10px; z-index: 10; }
        
        /* Navigation Bas */
        .nav-bottom { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.98); border-top: 1px solid #e0e0e0; padding: 10px; display: flex; justify-content: space-around; z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
        .nav-btn { border: none; background: none; display: flex; flex-direction: column; align-items: center; color: #6c757d; font-size: 0.75rem; }
        .nav-btn i { font-size: 1.5rem; margin-bottom: 2px; }
        
        /* Offline */
        .offline-badge { position: fixed; top: 15px; right: 15px; z-index: 9999; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<!-- Indicateur R√©seau -->
<div id="statusIndicator" class="badge bg-success offline-badge">En Ligne</div>

<!-- HEADER -->
<div class="header-app">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h4 class="m-0 fw-bold"><i class="bi bi-capsule"></i> Stock Pharma</h4>
            <small class="opacity-75" id="totalCountInfo">Chargement...</small>
        </div>
        <!-- LE BOUTON QUI POSAIT PROBLEME -->
        <button class="btn-config" onclick="openConfigModal()" type="button">
            <i class="bi bi-gear-fill fs-5"></i>
        </button>
    </div>
</div>

<div class="container mb-5">
    
    <!-- ZONE FILTRES -->
    <div class="filter-section mx-1">
        <div class="row g-2">
            <div class="col-6">
                <label class="small text-muted fw-bold text-uppercase">D√©p√¥t Actuel</label>
                <select id="depotSelect" class="form-select form-select-sm fw-bold border-primary text-primary">
                    <!-- Rempli par JS -->
                </select>
            </div>
            <div class="col-6">
                <label class="small text-muted fw-bold text-uppercase">Famille</label>
                <select id="familySelect" class="form-select form-select-sm">
                    <option value="ALL">üìÇ Tout voir</option>
                    <!-- Rempli par JS -->
                </select>
            </div>
        </div>
    </div>

    <!-- SCANNER -->
    <div id="reader" class="scanner-box">
        <button class="btn btn-danger btn-sm scanner-overlay" onclick="stopScanner()">Fermer X</button>
    </div>
    
    <!-- BARRE RECHERCHE -->
    <div class="input-group mb-3 shadow-sm">
        <input type="text" id="searchInput" class="form-control" placeholder="Recherche (Nom, Code, Lot)...">
        <button class="btn btn-dark" onclick="startScanner('search')">
            <i class="bi bi-qr-code-scan"></i> SCAN
        </button>
    </div>

    <!-- LISTE PRODUITS -->
    <div id="productList" class="pb-2">
        <div class="text-center mt-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted mt-2">Initialisation...</p>
        </div>
    </div>
</div>

<!-- ================= MODALES ================= -->

<!-- 1. MODALE FICHE PRODUIT -->
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light py-2">
                <h6 class="modal-title fw-bold text-primary"><i class="bi bi-pencil-square"></i> D√©tail Produit</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <form id="inventoryForm">
                    <input type="hidden" id="itemId">
                    
                    <!-- Titre -->
                    <div class="mb-3">
                        <label class="small text-muted">D√©signation (DCI)</label>
                        <input type="text" id="modalDesignation" class="form-control fw-bold fs-5">
                    </div>

                    <!-- Ligne 1 -->
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="small text-muted">Famille</label>
                            <select id="modalFamille" class="form-select form-select-sm"></select>
                        </div>
                        <div class="col-6">
                            <label class="small text-muted">Prix Vente (FCFA)</label>
                            <input type="number" id="modalPrix" class="form-control fw-bold text-success">
                        </div>
                    </div>

                    <!-- Ligne 2 (Lot) -->
                    <div class="card bg-light border-0 p-2 mb-3">
                        <div class="row g-2">
                            <div class="col-4">
                                <label class="small fw-bold">Unit√©</label>
                                <input type="text" id="modalUnite" class="form-control form-control-sm bg-white">
                            </div>
                            <div class="col-4">
                                <label class="small fw-bold">Lot</label>
                                <input type="text" id="modalLot" class="form-control form-control-sm font-monospace bg-white border-warning">
                            </div>
                            <div class="col-4">
                                <label class="small fw-bold">Exp</label>
                                <input type="date" id="modalDate" class="form-control form-control-sm bg-white border-warning">
                            </div>
                        </div>
                    </div>

                    <!-- Ligne 3 (Stock) -->
                    <div class="row g-2 align-items-center mb-3">
                        <div class="col-4 text-center">
                            <label class="small text-muted">Th√©orique</label>
                            <input type="number" id="modalQteTheo" class="form-control text-center bg-white border-0" readonly>
                        </div>
                        <div class="col-8">
                            <label class="small fw-bold text-primary w-100 text-center">STOCK PHYSIQUE</label>
                            <input type="number" id="modalQtePhys" class="form-control form-control-lg text-center border-primary fw-bold" style="font-size:1.6rem">
                        </div>
                    </div>

                    <!-- Ligne 4 (Barcodes) -->
                    <div class="border-top pt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="small text-muted fw-bold">Codes Barres associ√©s</label>
                            <button type="button" class="btn btn-sm btn-outline-dark" onclick="startScanner('add_barcode')">
                                <i class="bi bi-plus-lg"></i> Scan Ajout
                            </button>
                        </div>
                        <div id="barcodeTagsContainer" class="p-2 bg-light rounded mb-2" style="min-height: 35px;"></div>
                        <div class="input-group input-group-sm">
                            <input type="text" id="manualBarcodeInput" class="form-control" placeholder="Ajout manuel code...">
                            <button class="btn btn-outline-secondary" type="button" onclick="addManualBarcode()">OK</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-primary w-100 fw-bold py-2" onclick="saveItem()">üíæ ENREGISTRER</button>
            </div>
        </div>
    </div>
</div>

<!-- 2. MODALE CONFIGURATION (DEPOTS & FAMILLES) -->
<div class="modal fade" id="configModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h6 class="modal-title fw-bold"><i class="bi bi-gear-fill"></i> Param√®tres</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="configTabs">
                    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabDepots">D√©p√¥ts</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabFamilies">Familles</a></li>
                </ul>
                <div class="tab-content">
                    <!-- Onglet D√©p√¥ts -->
                    <div class="tab-pane fade show active" id="tabDepots">
                        <div class="input-group mb-3">
                            <input type="text" id="newDepotName" class="form-control" placeholder="Nom du d√©p√¥t...">
                            <button class="btn btn-success" onclick="addConfigItem('depots')"><i class="bi bi-plus-lg"></i></button>
                        </div>
                        <ul class="list-group list-group-flush" id="configDepotList" style="max-height: 300px; overflow-y:auto;"></ul>
                    </div>
                    <!-- Onglet Familles -->
                    <div class="tab-pane fade" id="tabFamilies">
                        <div class="input-group mb-3">
                            <input type="text" id="newFamilyName" class="form-control" placeholder="Nom de la famille...">
                            <button class="btn btn-success" onclick="addConfigItem('families')"><i class="bi bi-plus-lg"></i></button>
                        </div>
                        <ul class="list-group list-group-flush" id="configFamilyList" style="max-height: 300px; overflow-y:auto;"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NAV BAS -->
<div class="nav-bottom">
    <button class="nav-btn" onclick="addNewItem()">
        <i class="bi bi-plus-circle-fill fs-2 text-primary"></i>
        <span>Nouveau</span>
    </button>
    <button class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" onclick="syncData()">
        <i class="bi bi-arrow-repeat"></i> SYNCHRO
    </button>
    <button class="nav-btn" onclick="location.reload()">
        <i class="bi bi-house-door-fill fs-4"></i>
        <span>Accueil</span>
    </button>
</div>

<!-- ================= JAVASCRIPT ================= -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- 1. CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbzzv4nwHUPuCRwaAcMRrTfEcOB40xJ8hxHhO6cAjxq3N2FSuZzNBhlvtmzKoMZEnQPp/exec"; // <-- Votre URL
    
    // Initialisation Base de Donn√©es
    const db = new Dexie("PharmaUltimateDB_V1");
    db.version(1).stores({ 
        products: "ID, Famille, Designation, Barcodes, NumeroLot, Depot, PrixVente" 
    });

    // Variables Globales
    let currentDepot = "";
    let currentFamily = "ALL";
    let html5QrcodeScanner = null;
    let scanMode = "search"; 
    let currentEditingBarcodes = [];

    // Chargement s√©curis√© des configs locales
    let userDepots = ['Depot_Principal', 'BASE_ARTICLES'];
    let userFamilies = ['NON CLASSE', 'COMPRIMES', 'SIROPS', 'INJECTABLES'];

    try {
        const storedD = localStorage.getItem('userDepots');
        if(storedD) userDepots = JSON.parse(storedD);
        
        const storedF = localStorage.getItem('userFamilies');
        if(storedF) userFamilies = JSON.parse(storedF);
    } catch(e) {
        console.warn("Erreur chargement localStorage, utilisation defauts");
    }

    // --- 2. INITIALISATION AU CHARGEMENT ---
    document.addEventListener('DOMContentLoaded', () => {
        setupOfflineDetection();
        loadDataLocal(); // Compte les produits
        
        // Initialisation UI
        currentDepot = userDepots[0];
        updateDropdownsUI();
        
        // Listeners
        document.getElementById('depotSelect').addEventListener('change', (e) => { 
            currentDepot = e.target.value; 
            renderList(); 
        });
        document.getElementById('familySelect').addEventListener('change', (e) => { 
            currentFamily = e.target.value; 
            renderList(); 
        });
        document.getElementById('searchInput').addEventListener('input', (e) => handleSmartSearch(e.target.value));
    });

    // --- 3. GESTION DU BOUTON ROUE DENTEE (CONFIG) ---
    // Cette fonction doit √™tre globale (attach√©e √† window) pour l'onclick HTML
    window.openConfigModal = function() {
        updateDropdownsUI(); // Rafraichit les listes
        const modalEl = document.getElementById('configModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    };

    window.addConfigItem = function(type) {
        const inputId = type === 'depots' ? 'newDepotName' : 'newFamilyName';
        const val = document.getElementById(inputId).value.trim().replace(/ /g, "_");
        if(!val) return;

        if(type === 'depots') {
            if(!userDepots.includes(val)) userDepots.push(val);
            localStorage.setItem('userDepots', JSON.stringify(userDepots));
        } else {
            if(!userFamilies.includes(val)) userFamilies.push(val.toUpperCase());
            localStorage.setItem('userFamilies', JSON.stringify(userFamilies));
        }
        document.getElementById(inputId).value = "";
        updateDropdownsUI();
    };

    window.removeConfig = function(type, val) {
        if(!confirm("Supprimer " + val + " ?")) return;
        if(type === 'depots') {
            userDepots = userDepots.filter(d => d !== val);
            if(userDepots.length === 0) userDepots.push("Defaut");
            localStorage.setItem('userDepots', JSON.stringify(userDepots));
        } else {
            userFamilies = userFamilies.filter(f => f !== val);
            localStorage.setItem('userFamilies', JSON.stringify(userFamilies));
        }
        updateDropdownsUI();
    };

    function updateDropdownsUI() {
        // D√©p√¥ts
        const dSel = document.getElementById('depotSelect'); 
        const dList = document.getElementById('configDepotList');
        // Sauvegarder la s√©lection actuelle si elle existe
        const currentSel = dSel.value || currentDepot;
        
        dSel.innerHTML = "";
        dList.innerHTML = "";
        
        userDepots.forEach(d => {
            dSel.innerHTML += `<option value="${d}">${d}</option>`;
            dList.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${d} <button class="btn-close btn-sm" onclick="removeConfig('depots','${d}')"></button>
                </li>`;
        });
        
        // Restaurer la s√©lection ou prendre le premier
        dSel.value = userDepots.includes(currentSel) ? currentSel : userDepots[0];
        currentDepot = dSel.value;

        // Familles
        const fSel = document.getElementById('familySelect');
        const mFam = document.getElementById('modalFamille');
        const fList = document.getElementById('configFamilyList');
        const currentFamSel = fSel.value;

        fSel.innerHTML = '<option value="ALL">üìÇ Tout voir</option>';
        mFam.innerHTML = '';
        fList.innerHTML = '';

        userFamilies.sort().forEach(f => {
            fSel.innerHTML += `<option value="${f}">${f}</option>`;
            mFam.innerHTML += `<option value="${f}">${f}</option>`;
            fList.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${f} <button class="btn-close btn-sm" onclick="removeConfig('families','${f}')"></button>
                </li>`;
        });
        fSel.value = currentFamSel;
    }


    // --- 4. RECHERCHE INTELLIGENTE & MASTER BASE ---
    async function handleSmartSearch(text) {
        if(!text) { renderList(); return; }
        
        const listEl = document.getElementById('productList');
        listEl.innerHTML = "";
        const lowerFilter = text.toLowerCase();

        // A. Recherche LOCALE (D√©p√¥t actuel)
        const localItems = await db.products.where('Depot').equals(currentDepot).toArray();
        let matches = localItems.filter(item => 
            (item.Designation && item.Designation.toLowerCase().includes(lowerFilter)) ||
            (item.Barcodes && item.Barcodes.includes(text)) || 
            (item.NumeroLot && item.NumeroLot.toLowerCase().includes(lowerFilter))
        );

        // B. Recherche GLOBALE (Master Base)
        let globalMatches = [];
        if(matches.length === 0) {
            const allItems = await db.products.toArray();
            globalMatches = allItems.filter(item => 
                item.Depot !== currentDepot && (
                    (item.Designation && item.Designation.toLowerCase().includes(lowerFilter)) ||
                    (item.Barcodes && item.Barcodes.includes(text))
                )
            );
            // D√©doublonnage par ID Produit (pour ne pas afficher 50 lots du m√™me produit)
            globalMatches = globalMatches.filter((v,i,a)=>a.findIndex(t=>(t.ID === v.ID))===i);
        }

        if (matches.length > 0) {
            renderItemsHTML(matches, listEl);
        } else if (globalMatches.length > 0) {
            // Affichage des propositions d'import
            listEl.innerHTML = `<div class="alert alert-info py-2 small"><i class="bi bi-globe"></i> Non trouv√© ici, mais existe ailleurs :</div>`;
            globalMatches.forEach(item => {
                const html = `
                    <div class="card product-card import shadow-sm mb-2" onclick="importFromMaster('${item.ID}')">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between">
                                <h6 class="fw-bold text-primary m-0"><i class="bi bi-cloud-download"></i> ${item.Designation}</h6>
                                <span class="badge bg-info text-dark">IMPORT</span>
                            </div>
                            <small class="text-muted">Fam: ${item.Famille} | Prix: ${item.PrixVente || '?'} F</small>
                            <div class="text-end mt-2">
                                <button class="btn btn-sm btn-outline-primary">Ajouter √† ${currentDepot}</button>
                            </div>
                        </div>
                    </div>`;
                listEl.innerHTML += html;
            });
        } else {
            listEl.innerHTML = `<div class="text-center mt-5 text-muted">Rien trouv√©.<br><button class="btn btn-sm btn-outline-secondary mt-2" onclick="addNewItem()">+ Cr√©er Nouveau</button></div>`;
        }
    }

    // --- 5. LOGIQUE D'IMPORT & EDITION ---
    async function importFromMaster(masterId) {
        const masterItem = await db.products.get(masterId);
        if(!masterItem) return;
        if(confirm(`Importer la fiche "${masterItem.Designation}" dans ${currentDepot} ?`)) {
            // On ouvre la modale avec les donn√©es du Master, mais en mode "Nouveau Stock"
            await openEditModal(null, masterItem); 
        }
    }

    async function loadDataLocal() {
        const count = await db.products.count();
        document.getElementById('totalCountInfo').innerText = `${count} refs`;
        renderList();
    }

    async function renderList() {
        const listEl = document.getElementById('productList');
        listEl.innerHTML = "";
        
        let items = await db.products.where('Depot').equals(currentDepot).toArray();
        if (currentFamily !== "ALL") items = items.filter(i => i.Famille === currentFamily);

        renderItemsHTML(items, listEl);
    }

    function renderItemsHTML(items, container) {
        if (items.length === 0) {
            container.innerHTML = `<div class="text-center text-muted mt-5 opacity-50">Aucun produit.</div>`;
            return;
        }
        items.forEach(item => {
            const isDone = (item.QtePhysique !== "" && item.QtePhysique !== undefined);
            const html = `
                <div class="card product-card ${isDone ? 'done' : 'todo'}" onclick="openEditModal('${item.ID}')">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between mb-1">
                            <h6 class="m-0 fw-bold text-truncate" style="max-width:70%">${item.Designation}</h6>
                            <span class="price-badge">${item.PrixVente ? item.PrixVente + ' F' : '-'}</span>
                        </div>
                        <div class="small text-muted d-flex justify-content-between">
                            <span>Lot: <b>${item.NumeroLot || '-'}</b></span>
                            <span>Exp: ${formatDate(item.DatePeremption)}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top">
                            <span class="text-muted small">Th√©o: ${item.QteTheorique}</span>
                            <span class="fs-5 fw-bold ${isDone ? 'text-success' : 'text-secondary'}">
                                Phys: ${isDone ? item.QtePhysique : '...'}
                            </span>
                        </div>
                    </div>
                </div>`;
            container.innerHTML += html;
        });
    }

    // --- 6. MODALES & SAUVEGARDE ---
    window.openEditModal = async function(id, importData = null) {
        let item = {};
        
        if (id) {
            // Edition
            item = await db.products.get(id);
        } else if (importData) {
            // Import Master : On garde l'ID produit pour lier les fiches, mais on change la cl√© primaire plus tard
            item = { ...importData }; 
            item.Depot = currentDepot; // Force le d√©p√¥t actuel
            item.NumeroLot = ""; // Reset lot car nouveau stock
            item.QteTheorique = 0;
            item.QtePhysique = "";
        } else {
            // Cr√©ation Vierge
            item = { ID: "GEN_" + Date.now(), Depot: currentDepot, Famille: currentFamily!=="ALL"?currentFamily:userFamilies[0], PrixVente:"" };
        }

        // Configuration ID (Cl√© primaire Dexie)
        // Si on importe, on cr√©e une nouvelle entr√©e, donc on change l'ID technique
        if(importData) {
            document.getElementById('itemId').value = "STOCK_" + Date.now();
        } else {
            document.getElementById('itemId').value = item.ID;
        }

        document.getElementById('modalDesignation').value = item.Designation || "";
        document.getElementById('modalFamille').value = item.Famille || "NON CLASSE";
        document.getElementById('modalUnite').value = item.Unite || "";
        document.getElementById('modalPrix').value = item.PrixVente || "";
        document.getElementById('modalLot').value = item.NumeroLot || "";
        
        let d = item.DatePeremption ? new Date(item.DatePeremption).toISOString().split('T')[0] : "";
        document.getElementById('modalDate').value = d;
        document.getElementById('modalQteTheo').value = item.QteTheorique || 0;
        document.getElementById('modalQtePhys').value = item.QtePhysique !== undefined ? item.QtePhysique : "";

        currentEditingBarcodes = item.Barcodes ? String(item.Barcodes).split(',').filter(c=>c.trim()!=="") : [];
        renderBarcodeTags();

        new bootstrap.Modal(document.getElementById('productModal')).show();
    };

    function renderBarcodeTags() {
        const c = document.getElementById('barcodeTagsContainer'); c.innerHTML = "";
        currentEditingBarcodes.forEach((code, i) => {
            c.innerHTML += `<span class="barcode-tag">${code} <i class="bi bi-x ms-2" onclick="removeBarcode(${i})" style="cursor:pointer"></i></span>`;
        });
    }
    window.removeBarcode = function(i) { currentEditingBarcodes.splice(i, 1); renderBarcodeTags(); };
    window.addManualBarcode = function() {
        const v = document.getElementById('manualBarcodeInput').value.trim();
        if(v && !currentEditingBarcodes.includes(v)) { currentEditingBarcodes.push(v); renderBarcodeTags(); document.getElementById('manualBarcodeInput').value=""; }
    };
    window.addNewItem = function() { openEditModal(null); };

    window.saveItem = async function() {
        const id = document.getElementById('itemId').value;
        const item = {
            ID: id,
            Designation: document.getElementById('modalDesignation').value,
            Famille: document.getElementById('modalFamille').value,
            Unite: document.getElementById('modalUnite').value,
            PrixVente: document.getElementById('modalPrix').value,
            NumeroLot: document.getElementById('modalLot').value,
            DatePeremption: document.getElementById('modalDate').value,
            QteTheorique: document.getElementById('modalQteTheo').value,
            QtePhysique: document.getElementById('modalQtePhys').value,
            Barcodes: currentEditingBarcodes.join(','),
            Depot: currentDepot
        };
        await db.products.put(item);
        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
        renderList();
    };

    // --- 7. SCANNER ---
    window.startScanner = function(mode) {
        scanMode = mode;
        const reader = document.getElementById('reader');
        reader.style.display = "block";
        
        // Cache la modale pour voir le scanner si ajout
        if(mode==='add_barcode') bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
        
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (code) => {
            await html5QrcodeScanner.stop();
            reader.style.display = "none";
            handleScanResult(code);
        });
    };
    window.stopScanner = async function() {
        if(html5QrcodeScanner) await html5QrcodeScanner.stop();
        document.getElementById('reader').style.display = "none";
        // Si on √©tait en mode ajout, on r√©ouvre la modale
        if(scanMode === 'add_barcode') {
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }
    };

    async function handleScanResult(code) {
        let clean = code.replace(/[\(\)]/g, ''); 
        if(clean.startsWith('01') && clean.length>14) clean = clean.substring(2,16).replace(/^0+/, ''); 

        if(scanMode === 'add_barcode') {
            const modalEl = document.getElementById('productModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
            if(!currentEditingBarcodes.includes(clean)) { currentEditingBarcodes.push(clean); renderBarcodeTags(); }
        } else {
            document.getElementById('searchInput').value = clean;
            handleSmartSearch(clean);
        }
    }

    // --- 8. SYNCHRO ---
    window.syncData = async function() {
        const btn = document.querySelector('.btn-primary.rounded-pill');
        const oldTxt = btn.innerHTML;
        btn.innerHTML = "‚è≥ Envoi..."; btn.disabled = true;
        
        try {
            const allData = await db.products.toArray();
            // 1. Envoi
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type':'application/json'}, body: JSON.stringify(allData)});
            
            btn.innerHTML = "üì• R√©ception...";
            await new Promise(r => setTimeout(r, 2000));
            
            // 2. R√©ception (Anti-cache)
            const res = await fetch(API_URL + "?t=" + Date.now());
            const raw = await res.json();
            
            // 3. Nettoyage
            const clean = raw.map(i => {
                const k = (n) => Object.keys(i).find(key => key.toLowerCase() === n.toLowerCase());
                return {
                    ID: i[k("id")] || ("GEN_" + Math.random()),
                    Famille: i[k("famille")] || "DIVERS",
                    Designation: i[k("designation")] || "?",
                    Unite: i[k("unite")] || "U",
                    Barcodes: String(i[k("barcodes")] || ""),
                    NumeroLot: String(i[k("numerolot")] || ""),
                    DatePeremption: i[k("dateperemption")] || "",
                    QteTheorique: i[k("qtetheorique")] || 0,
                    QtePhysique: i[k("qtephysique")],
                    Depot: i[k("depot")] || "Depot_Principal",
                    PrixVente: i[k("prixvente")] || ""
                };
            });
            
            await db.products.clear(); 
            await db.products.bulkPut(clean);
            
            alert(`‚úÖ Termin√© : ${clean.length} produits √† jour.`);
            location.reload(); 

        } catch(e) { 
            alert("Erreur Synchro: " + e.message); 
        } finally { 
            btn.innerHTML = oldTxt; btn.disabled = false; 
        }
    };

    // --- UTILS ---
    function setupOfflineDetection() {
        const badge = document.getElementById('statusIndicator');
        const up = () => { badge.className = navigator.onLine ? "badge bg-success offline-badge" : "badge bg-danger offline-badge"; badge.innerText = navigator.onLine ? "En Ligne" : "Hors Ligne"; };
        window.addEventListener('online', up); window.addEventListener('offline', up); up();
    }
    function formatDate(d) { if(!d)return ""; const dd=new Date(d); return isNaN(dd)?d:dd.toLocaleDateString('fr-FR'); }
    if('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');
</script>
</body>
</html>