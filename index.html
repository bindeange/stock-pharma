<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pharma Stock Pro</title>
    
    <!-- CSS Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Librairies JS -->
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link rel="manifest" href="manifest.json">
    
    <style>
        body { padding-bottom: 110px; background-color: #f4f6f8; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        /* En-t√™te */
        .header-app { background: linear-gradient(135deg, #0d6efd, #0043a8); color: white; padding: 15px 15px 30px 15px; border-radius: 0 0 20px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        
        /* Zone de filtres */
        .filter-section { background: white; padding: 15px; border-radius: 12px; margin-top: -25px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border: 1px solid #eef2f5; }
        
        /* Scanner */
        .scanner-box { width: 100%; display: none; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 15px; border: 2px solid #333; }
        
        /* Carte Produit */
        .product-card { border: none; border-radius: 10px; margin-bottom: 12px; transition: transform 0.1s; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-left: 5px solid #dee2e6; }
        .product-card:active { transform: scale(0.98); }
        .product-card.done { border-left-color: #198754; background-color: #f6fffa; } /* Vert si fait */
        .product-card.todo { border-left-color: #ffc107; } /* Jaune si √† faire */
        
        /* Badges et Textes */
        .lot-badge { font-family: monospace; background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-size: 0.85em; }
        .offline-badge { position: fixed; top: 10px; right: 10px; z-index: 9999; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* Navigation Bas */
        .nav-bottom { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #e0e0e0; padding: 12px 10px; display: flex; justify-content: space-around; z-index: 1000; box-shadow: 0 -4px 15px rgba(0,0,0,0.05); }
        .nav-btn { display: flex; flex-direction: column; align-items: center; border: none; background: none; font-size: 0.75rem; color: #6c757d; font-weight: 500; }
        .nav-btn.active { color: #0d6efd; }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }
        
        /* Inputs Modale */
        .big-input { font-size: 1.5rem; font-weight: 800; text-align: center; color: #0d6efd; height: 60px; }
    </style>
</head>
<body>

<!-- Badge Statut R√©seau -->
<div id="statusIndicator" class="badge bg-success offline-badge">En Ligne</div>

<!-- En-t√™te -->
<div class="header-app">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h4 class="m-0 fw-bold">üì¶ Stock Pharma</h4>
            <small class="opacity-75" id="totalCountInfo">Chargement...</small>
        </div>
        <div class="spinner-border text-light spinner-border-sm" id="syncSpinner" style="display:none"></div>
    </div>
</div>

<div class="container mb-5">
    
    <!-- Filtres (D√©p√¥t & Famille) -->
    <div class="filter-section mx-1 mb-3">
        <div class="row g-2">
            <div class="col-6">
                <label class="small text-muted fw-bold text-uppercase">1. D√©p√¥t</label>
                <select id="depotSelect" class="form-select form-select-sm fw-bold border-primary">
                    <option value="Depot_Principal">üè• Principal</option>
                    <option value="Depot_Secondaire">üöë Urgence</option>
                    <option value="Depot_Reserve">üì¶ R√©serve</option>
                </select>
            </div>
            <div class="col-6">
                <label class="small text-muted fw-bold text-uppercase">2. Famille</label>
                <select id="familySelect" class="form-select form-select-sm">
                    <option value="ALL">üìÇ Tout voir</option>
                    <!-- Sera rempli par JS -->
                </select>
            </div>
        </div>
    </div>

    <!-- Scanner & Recherche -->
    <div id="reader" class="scanner-box"></div>
    
    <div class="input-group mb-3 shadow-sm">
        <span class="input-group-text bg-white border-end-0">üîç</span>
        <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Rechercher (Nom, code...)">
        <button class="btn btn-dark" onclick="startScanner()">üì∑ SCAN</button>
    </div>

    <!-- Liste Produits -->
    <div id="productList" class="pb-2">
        <div class="text-center mt-5 text-muted">
            <div class="spinner-border text-primary mb-3"></div>
            <p>Chargement de la base...</p>
        </div>
    </div>
</div>

<!-- MODALE FICHE PRODUIT -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light py-2">
                <h6 class="modal-title fw-bold text-primary">üìù √âdition Produit</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <form id="inventoryForm">
                    <input type="hidden" id="itemId">
                    
                    <!-- Titre Produit -->
                    <div class="mb-3">
                        <label class="small text-muted">D√©signation (DCI)</label>
                        <input type="text" id="modalDesignation" class="form-control fw-bold text-dark" style="background:#f8f9fa;">
                    </div>

                    <!-- Ligne Famille / Unit√© -->
                    <div class="row g-2 mb-3">
                        <div class="col-7">
                            <label class="small text-muted">Famille</label>
                            <select id="modalFamille" class="form-select form-select-sm">
                                <option value="NON CLASSE">NON CLASSE</option>
                                <!-- Sera rempli dynamiquement -->
                            </select>
                        </div>
                        <div class="col-5">
                            <label class="small text-muted">Unit√©</label>
                            <input type="text" id="modalUnite" class="form-control form-control-sm">
                        </div>
                    </div>

                    <!-- Ligne Lot / Date -->
                    <div class="card bg-light border-0 p-2 mb-3">
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="small fw-bold text-dark">N¬∞ Lot</label>
                                <input type="text" id="modalLot" class="form-control font-monospace border-warning">
                            </div>
                            <div class="col-6">
                                <label class="small fw-bold text-dark">P√©remption</label>
                                <input type="date" id="modalDate" class="form-control border-warning">
                            </div>
                        </div>
                    </div>

                    <!-- Zone Comptage -->
                    <div class="row g-2 align-items-center mb-3">
                        <div class="col-5 text-center">
                            <label class="small text-muted">Th√©orique</label>
                            <input type="number" id="modalQteTheo" class="form-control text-center bg-white border-0" readonly tabindex="-1">
                        </div>
                        <div class="col-7">
                            <label class="small fw-bold text-primary w-100 text-center">QUANTIT√â PHYSIQUE</label>
                            <input type="number" id="modalQtePhys" class="form-control big-input border-primary shadow-sm" placeholder="0">
                        </div>
                    </div>

                    <!-- Codes Barres -->
                    <div class="mt-3 pt-3 border-top">
                        <label class="small text-muted">Codes Barres (S√©par√©s par virgule)</label>
                        <textarea id="modalBarcodes" class="form-control form-control-sm text-muted" rows="1"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary fw-bold px-4" onclick="saveItem()">üíæ ENREGISTRER</button>
            </div>
        </div>
    </div>
</div>

<!-- Navigation Bas -->
<div class="nav-bottom">
    <button class="nav-btn" onclick="addNewItem()">
        <span class="nav-icon">‚ûï</span>
        <span>Nouveau</span>
    </button>
    
    <!-- Bouton Synchro Central -->
    <button class="btn btn-primary rounded-pill px-4 shadow fw-bold" onclick="syncData()">
        üîÑ SYNCHRO
    </button>
    
    <button class="nav-btn" onclick="location.reload()">
        <span class="nav-icon">üè†</span>
        <span>Accueil</span>
    </button>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ============================================================
    // 1. CONFIGURATION
    // ============================================================
    
    // üëá COLLEZ VOTRE URL GOOGLE APPS SCRIPT ICI üëá
    const API_URL = "https://script.google.com/macros/s/AKfycbzzv4nwHUPuCRwaAcMRrTfEcOB40xJ8hxHhO6cAjxq3N2FSuZzNBhlvtmzKoMZEnQPp/exec";

    // Base de donn√©es locale (IndexedDB via Dexie)
    const db = new Dexie("PharmaStockDB_Expert");
    db.version(1).stores({
        products: "ID, Famille, Designation, Barcodes, NumeroLot, Depot"
    });

    let currentDepot = "Depot_Principal";
    let currentFamily = "ALL";
    let html5QrcodeScanner = null;
    let allFamiliesList = [];

    // ============================================================
    // 2. INITIALISATION
    // ============================================================
    document.addEventListener('DOMContentLoaded', () => {
        setupOfflineDetection();
        loadDataLocal(); // Charge les donn√©es au d√©marrage

        // Ecouteurs
        document.getElementById('depotSelect').addEventListener('change', (e) => {
            currentDepot = e.target.value;
            renderList();
        });
        document.getElementById('familySelect').addEventListener('change', (e) => {
            currentFamily = e.target.value;
            renderList();
        });
        document.getElementById('searchInput').addEventListener('input', (e) => {
            renderList(e.target.value);
        });
    });

    // ============================================================
    // 3. AFFICHAGE & FILTRES
    // ============================================================
    async function loadDataLocal() {
        const count = await db.products.count();
        document.getElementById('totalCountInfo').innerText = `${count} refs en stock`;
        
        if (count > 0) {
            await updateFamilyDropdown();
            renderList();
        } else {
            document.getElementById('productList').innerHTML = `
                <div class="text-center mt-5 p-4 bg-white rounded shadow-sm mx-3">
                    <h4>üëã Bienvenue</h4>
                    <p class="text-muted">Votre base est vide.</p>
                    <button class="btn btn-primary btn-lg w-100" onclick="syncData()">üì• T√©l√©charger le Stock</button>
                </div>`;
        }
    }

    async function updateFamilyDropdown() {
        // R√©cup√®re toutes les familles distinctes pour le filtre
        const allItems = await db.products.toArray();
        const families = [...new Set(allItems.map(item => item.Famille || "NON CLASSE"))].sort();
        allFamiliesList = families;

        // Mise √† jour select principal
        const select = document.getElementById('familySelect');
        const oldVal = select.value;
        select.innerHTML = '<option value="ALL">üìÇ Tout voir</option>';
        families.forEach(fam => {
            if(fam.trim() !== "") select.innerHTML += `<option value="${fam}">${fam}</option>`;
        });
        select.value = "ALL";

        // Mise √† jour select dans la Modale
        const modalSelect = document.getElementById('modalFamille');
        modalSelect.innerHTML = '<option value="NON CLASSE">NON CLASSE</option>';
        families.forEach(fam => {
             modalSelect.innerHTML += `<option value="${fam}">${fam}</option>`;
        });
    }

    async function renderList(filterText = "") {
        const listEl = document.getElementById('productList');
        listEl.innerHTML = "";

        // Etape A : Filtre D√©p√¥t
        let items = await db.products.where('Depot').equals(currentDepot).toArray();

        // Etape B : Filtre Famille
        if (currentFamily !== "ALL") {
            items = items.filter(i => i.Famille === currentFamily);
        }

        // Etape C : Recherche Texte
        if (filterText) {
            const lowerFilter = filterText.toLowerCase();
            items = items.filter(item => 
                (item.Designation && item.Designation.toLowerCase().includes(lowerFilter)) ||
                (item.Barcodes && item.Barcodes.includes(filterText)) || 
                (item.NumeroLot && item.NumeroLot.toLowerCase().includes(lowerFilter))
            );
        }

        if (items.length === 0) {
            listEl.innerHTML = `<div class="text-center text-muted mt-5 opacity-50">Aucun produit trouv√©.</div>`;
            return;
        }

        // G√©n√©ration HTML Optimis√©e
        const fragment = document.createDocumentFragment();
        items.forEach(item => {
            const isDone = (item.QtePhysique !== "" && item.QtePhysique !== null && item.QtePhysique !== undefined);
            const cardClass = isDone ? "done" : "todo";
            const valPhys = isDone ? item.QtePhysique : '...';
            
            const div = document.createElement('div');
            div.className = `card product-card ${cardClass}`;
            div.onclick = () => openEditModal(item.ID);
            div.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title m-0 fw-bold text-dark" style="line-height:1.4">${item.Designation}</h6>
                        <span class="badge bg-white text-secondary border ms-2">${item.Unite || 'U'}</span>
                    </div>
                    
                    <div class="d-flex justify-content-between small text-muted mb-3">
                        <div>Lot: <span class="lot-badge text-dark">${item.NumeroLot || '-'}</span></div>
                        <div>Exp: ${formatDate(item.DatePeremption)}</div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                        <div class="text-muted small">Th√©o: <strong>${item.QteTheorique}</strong></div>
                        <div class="${isDone ? 'text-success' : 'text-secondary'} fw-bold fs-5">
                            Phys: ${valPhys}
                        </div>
                    </div>
                </div>
            `;
            fragment.appendChild(div);
        });
        listEl.appendChild(fragment);
    }

    // ============================================================
    // 4. MODALE & EDITION
    // ============================================================
    async function openEditModal(id) {
        const item = await db.products.get(id);
        if(!item) return;

        document.getElementById('itemId').value = item.ID;
        document.getElementById('modalDesignation').value = item.Designation;
        document.getElementById('modalUnite').value = item.Unite;
        document.getElementById('modalLot').value = item.NumeroLot;
        
        let dateVal = item.DatePeremption ? new Date(item.DatePeremption).toISOString().split('T')[0] : "";
        document.getElementById('modalDate').value = dateVal;
        
        document.getElementById('modalQteTheo').value = item.QteTheorique;
        document.getElementById('modalQtePhys').value = item.QtePhysique;
        document.getElementById('modalBarcodes').value = item.Barcodes;
        
        // Gestion Select Famille (ajout dynamique si nouvelle famille)
        const modalSel = document.getElementById('modalFamille');
        if (![...modalSel.options].some(o => o.value === item.Famille)) {
            modalSel.innerHTML += `<option value="${item.Famille}">${item.Famille}</option>`;
        }
        modalSel.value = item.Famille;

        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
        
        // Focus auto
        setTimeout(() => document.getElementById('modalQtePhys').focus(), 500);
    }

    async function addNewItem() {
        const newId = "NEW_" + Date.now(); 
        const newItem = {
            ID: newId,
            Designation: "", 
            Famille: currentFamily !== "ALL" ? currentFamily : "DIVERS",
            Depot: currentDepot,
            QteTheorique: 0,
            QtePhysique: "",
            Barcodes: "",
            NumeroLot: "",
            Unite: "Bt"
        };
        await db.products.put(newItem);
        openEditModal(newId);
    }

    async function saveItem() {
        const id = document.getElementById('itemId').value;
        const item = await db.products.get(id);

        if(item) {
            item.Designation = document.getElementById('modalDesignation').value;
            item.Famille = document.getElementById('modalFamille').value;
            item.Unite = document.getElementById('modalUnite').value;
            item.NumeroLot = document.getElementById('modalLot').value;
            item.DatePeremption = document.getElementById('modalDate').value;
            item.QtePhysique = document.getElementById('modalQtePhys').value;
            item.Barcodes = document.getElementById('modalBarcodes').value;
            
            await db.products.put(item);
            
            const modalEl = document.getElementById('productModal');
            bootstrap.Modal.getInstance(modalEl).hide();
            
            updateFamilyDropdown(); // Au cas o√π la famille change
            renderList();
        }
    }

    // ============================================================
    // 5. SYNCHRONISATION (CORRIG√âE : FORCE LE TELECHARGEMENT)
    // ============================================================
    async function syncData() {
        const btn = document.querySelector('.btn-primary.rounded-pill');
        const spinner = document.getElementById('syncSpinner');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = "‚è≥ Envoi...";
        btn.disabled = true;
        spinner.style.display = 'block';

        try {
            // 1. PUSH (Envoi local vers Google)
            const allLocalData = await db.products.toArray();
            await fetch(API_URL, {
                method: 'POST', 
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(allLocalData)
            });

            // 2. DELAI DE TRAITEMENT
            btn.innerHTML = "üì• R√©ception...";
            await new Promise(r => setTimeout(r, 2500)); // 2.5s pour √™tre s√ªr

            // 3. PULL (R√©ception avec Anti-Cache)
            // L'ajout de ?t=... force le navigateur √† ne pas utiliser le cache
            const response = await fetch(API_URL + "?t=" + Date.now());
            
            if (!response.ok) throw new Error("Erreur r√©seau Google");
            
            const rawData = await response.json();
            
            if (!Array.isArray(rawData)) throw new Error("Format de donn√©es invalide");

            // 4. NETTOYAGE & REMPLACEMENT
            // Fonction pour trouver une cl√© insensible √† la casse (Id, ID, id...)
            const cleanData = rawData.map(item => {
                const getKey = (keyName) => Object.keys(item).find(k => k.toLowerCase() === keyName.toLowerCase());
                
                return {
                    ID: item[getKey("id")] || ("GEN_" + Math.random()), 
                    Famille: item[getKey("famille")] || "NON CLASSE",
                    Designation: item[getKey("designation")] || "Inconnu",
                    Unite: item[getKey("unite")] || "U",
                    Barcodes: String(item[getKey("barcodes")] || ""),
                    NumeroLot: String(item[getKey("numerolot")] || ""),
                    DatePeremption: item[getKey("dateperemption")] || "",
                    QteTheorique: item[getKey("qtetheorique")] || 0,
                    QtePhysique: item[getKey("qtephysique")], 
                    Depot: item[getKey("depot")] || "Depot_Principal" 
                };
            });

            // On remplace tout
            await db.products.clear();
            await db.products.bulkPut(cleanData);

            // Refresh UI
            await loadDataLocal();
            document.getElementById('familySelect').value = "ALL";
            currentFamily = "ALL";
            renderList();

            alert(`‚úÖ Synchronisation R√©ussie !\n\nüì¶ Stock Google import√© : ${cleanData.length} produits.`);

        } catch (error) {
            console.error(error);
            alert("‚ùå Erreur de Synchro :\n" + error.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            spinner.style.display = 'none';
        }
    }

    // ============================================================
    // 6. SCANNER INTELLIGENT (GS1)
    // ============================================================
    function parseGS1(code) {
        let res = { gtin: null, lot: null, exp: null };
        let clean = code.replace(/[\(\)]/g, '');
        
        let mGtin = clean.match(/(?:01)(\d{14})/); 
        if(mGtin) res.gtin = mGtin[1];
        
        let mDate = clean.match(/17(\d{6})/); 
        if(mDate) res.exp = parseGS1Date(mDate[1]);
        
        let mLot = clean.match(/10([A-Za-z0-9\-\.]+)/); 
        if(mLot) {
            let l = mLot[1];
            let idx = l.indexOf('17'); // Si date suit le lot sans s√©parateur
            if(idx > -1 && l.length - idx >= 8) l = l.substring(0, idx);
            res.lot = l;
        }
        return res;
    }
    
    function parseGS1Date(d) {
        if(!d || d.length !== 6) return "";
        let y = parseInt(d.substring(0,2)); y += (y>50?1900:2000);
        let da = (d.substring(4,6)==="00")?"28":d.substring(4,6);
        return `${y}-${d.substring(2,4)}-${da}`;
    }

    function startScanner() {
        document.getElementById('reader').style.display = "block";
        html5QrcodeScanner = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: 250, formatsToSupport: [0,1,2,3,4,5,6,7,8,9,10,11,12,13] }; // Support All
        
        html5QrcodeScanner.start({ facingMode: "environment" }, config, async (code) => {
            await html5QrcodeScanner.stop();
            document.getElementById('reader').style.display = "none";
            handleScan(code);
        });
    }

    async function handleScan(code) {
        const gs1 = parseGS1(code);
        let search = gs1.gtin ? (gs1.gtin.startsWith('0')?gs1.gtin.substring(1):gs1.gtin) : code;
        
        document.getElementById('searchInput').value = search;
        
        // Recherche Globale (peu importe le filtre famille)
        const allItems = await db.products.where('Depot').equals(currentDepot).toArray();
        let found = allItems.find(i => i.Barcodes && i.Barcodes.includes(search));
        
        if(!found && search !== code) found = allItems.find(i => i.Barcodes && i.Barcodes.includes(code));

        if(found) {
            // Si le produit est dans une famille masqu√©e, on change le filtre
            if(currentFamily !== "ALL" && found.Famille !== currentFamily) {
                 document.getElementById('familySelect').value = found.Famille;
                 currentFamily = found.Famille;
                 renderList();
            }
            
            await openEditModal(found.ID);
            
            if(gs1.lot) document.getElementById('modalLot').value = gs1.lot;
            if(gs1.exp) document.getElementById('modalDate').value = gs1.exp;
            
            // Effet visuel
            document.getElementById('modalQtePhys').classList.add('bg-warning', 'bg-opacity-25');
        } else {
            if(confirm(`Nouveau produit : ${search}\nL'ajouter maintenant ?`)) {
                await addNewItem();
                setTimeout(() => {
                    document.getElementById('modalBarcodes').value = search;
                    if(gs1.lot) document.getElementById('modalLot').value = gs1.lot;
                    if(gs1.exp) document.getElementById('modalDate').value = gs1.exp;
                }, 500);
            }
        }
    }

    // ============================================================
    // 7. UTILS
    // ============================================================
    function setupOfflineDetection() {
        const badge = document.getElementById('statusIndicator');
        const update = () => {
            if (navigator.onLine) {
                badge.className = "badge bg-success offline-badge";
                badge.innerText = "En Ligne";
            } else {
                badge.className = "badge bg-danger offline-badge";
                badge.innerText = "Hors Ligne";
            }
        };
        window.addEventListener('online', update);
        window.addEventListener('offline', update);
        update();
    }

    function formatDate(d) { 
        if(!d) return ""; 
        const date = new Date(d);
        return isNaN(date) ? d : date.toLocaleDateString('fr-FR');
    }

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');
</script>
</body>
</html>